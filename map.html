<!DOCTYPE html>
<html>
	<head>
		<title>Where's That Sat Map</title>
		<style type="text/css">
			html {
				height: 100%;
			}
			body {
				height: 100%;
				margin: 0;
				padding: 0;
			}
			
			.row, .col {
				overflow: hidden;
				position: absolute;
			}
			
			.row {
				left: 0;
				right: 0;
			}
			
			.col {
				top: 0;
				bottom: 0;
			}
			
			.scrollx {
				overflow-x: auto;
			}
			
			.scrolly {
				overflow-y: auto;
			}
			
			.scrollx, .scrolly {
				-webkit-overflow-scrolling: touch;
			}
			
			#header {
			
				top: 0;
				height: 30px;
				
			}
			
			#content {
			
				top: 30px; /* header height */
				bottom: 0; /* footer height */
			}
						
			#map_canvas {
			
				left: 0;
				right: 0; /* rightpanel width */
				height: 100%;
			
			}
			
			#rightpanel {
				
				right: 0;
				width: 0; /* 200px */
				height: 100%;
				
			}
			
			#footer {
			
				bottom: 0;
				height: 0;
				
			}
			
			div.satmarker, #observer-marker {
				border: 2px solid transparent;
			}
			
			#header {
				background-color: #AAAADD;
			}
			#rightpanel {
				background-color: #AAAADD;
			}
			.locinfo {
				clear: both;
				margin: 3px;
				padding: 6px;
				border: solid 2px gray;
				background-color: white;
				font-family: Verdana, sans-serif;
				font-size: small;
			}
			
			.locinfo p {
				margin: 0px;
				margin-top: 6px;
			}
			
			.locinfo p:first-child {
				margin-top: 0;
			}
			
		</style>
		<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=AIzaSyCZoi0fBwcBhvhe_UdzI0q8zBNKv6yoQ0U&sensor=false"></script>
		<script src="http://platform.twitter.com/widgets.js" charset="utf-8"></script>
		<script type="text/javascript" src="scripts/QueryString.js"></script>
		<script type="text/javascript" src="scripts/richmarker.js"></script>
		<script type="text/javascript">
			
			function CoordinateParameterToLatLon(coordinates) {
				var latlon_strings = coordinates.split(',');
				return latlon_strings.map(function(x) {return parseFloat(x);});
			}
			
			// heading must be in range [0-360]
			function HeadingToCompassDirection(heading) {
				// per https://en.wikipedia.org/wiki/Boxing_the_compass
				if (heading >= 0 && heading < 5.62)
					return "north";
				else if (heading >= 5.62 && heading < 16.87)
					return "north by east";
				else if (heading >= 16.87 && heading < 28.12)
					return "north-northeast";
				else if (heading >= 28.12 && heading < 39.37)
					return "northeast by north";
				else if (heading >= 39.37 && heading < 50.62)
					return "northeast";
				else if (heading >= 50.62 && heading < 61.87)
					return "northeast by east";
				else if (heading >= 61.87 && heading < 73.12)
					return "east-northeast";
				else if (heading >= 73.12 && heading < 84.37)
					return "east by north";
				else if (heading >= 84.37 && heading < 95.62)
					return "east";
				else if (heading >= 95.62 && heading < 106.87)
					return "east by south";
				else if (heading >= 106.87 && heading < 118.12)
					return "east-southeast";
				else if (heading >= 118.12 && heading < 129.37)
					return "southeast by east";
				else if (heading >= 129.37 && heading < 140.62)
					return "southeast";
				else if (heading >= 140.62 && heading < 151.87)
					return "southeast by south";
				else if (heading >= 151.87 && heading < 163.12)
					return "south-southeast";
				else if (heading >= 163.12 && heading < 174.37)
					return "south by east";
				else if (heading >= 174.37 && heading < 185.62)
					return "south";
				else if (heading >= 185.62 && heading < 196.87)
					return "south by west";
				else if (heading >= 196.87 && heading < 208.12)
					return "south-southwest";
				else if (heading >= 208.12 && heading < 219.37)
					return "southwest by south";
				else if (heading >= 219.37 && heading < 230.62)
					return "southwest";
				else if (heading >= 230.62 && heading < 241.87)
					return "southwest by west";
				else if (heading >= 241.87 && heading < 253.12)
					return "west-southwest";
				else if (heading >= 253.12 && heading < 264.37)
					return "west by south";
				else if (heading >= 264.37 && heading < 275.62)
					return "west";
				else if (heading >= 275.62 && heading < 286.87)
					return "west by north";
				else if (heading >= 286.87 && heading < 298.12)
					return "west-northwest";
				else if (heading >= 298.12 && heading < 309.37)
					return "northwest by west";
				else if (heading >= 309.37 && heading < 320.62)
					return "northwest";
				else if (heading >= 320.62 && heading < 331.87)
					return "northwest by north";
				else if (heading >= 331.87 && heading < 343.12)
					return "north-northwest";
				else if (heading >= 343.12 && heading < 354.37)
					return "north by west";
				else if (heading >= 354.37 && heading <= 360)
					return "north";
			}
			
			function FormatTimestamp(timestamp) {
				return timestamp.toDateString() + ' at ' + timestamp.toTimeString();
				//return timestamp.toUTCString();
			}
			
			function FormatLatLon(latlon) {
				var lat = latlon[0];
				var lon = latlon[1];
				var lat_hem = 'N';
				var lon_hem = 'E';
				if (lat < 0)
					lat_hem = 'S';
				if (lon < 0)
					lon_hem = 'W';
				return Math.abs(lat).toString() + lat_hem + ' ' +
						Math.abs(lon).toString() + lon_hem;
			}
			
			function AddInfoToPanel(panel, caption, id) {
				var infodiv = document.createElement('div');
				infodiv.className = 'locinfo';
				infodiv.setAttribute('id', id + '-info');
				infodiv.innerHTML = caption;
				panel.appendChild(infodiv);
				return infodiv;
			}
			
			function MarkPlace(map, q, altitude_arg, heading_arg, speed_arg, time_arg,
					coordinates_arg, illumination_arg, elevation_arg, azimuth_arg,
					solarelev_arg, user_name, satellite_name, icon_path, panel, id, intro) {
				var altitude = parseFloat(q.value(altitude_arg));
				var heading = parseFloat(q.value(heading_arg));
				var direction = HeadingToCompassDirection(heading);
				var speed = parseFloat(q.value(speed_arg));
				var timestamp = new Date(parseInt(q.value(time_arg)) * 1000);
				var iconHTML = '<div id="' + id + '-marker" class="satmarker" style="-webkit-transform: rotate(' + heading + 'deg); -webkit-transform-origin: 50% 0%;"><img src="' + icon_path + '"></div>';
								//-moz-transform: rotate(360deg); -o-transform: rotate(360deg);-ms-transform: rotate(360deg);
				var ll = CoordinateParameterToLatLon(q.value(coordinates_arg));
				var point = new google.maps.LatLng(ll[0], ll[1]);
				var marker = new RichMarker({
						position: point,
						clickable: false,
						draggable: false,
						anchor: RichMarkerPosition.TOP,
						flat: true,
						map: map,
						content: iconHTML});
				var caption = '<p><img src="' + icon_path + '" style="float:left;"></p><p>'+ intro + ' on ' + FormatTimestamp(timestamp) +
						', ' + satellite_name + ' was at an altitude of ' +	altitude + ' km above ' + FormatLatLon(ll) +
						', moving ' + direction + ' (' + heading + '&deg;) at ' + speed + ' km/s.</p>';
				
				if (q.exists(illumination_arg) && q.exists(elevation_arg) && q.exists(azimuth_arg) && q.exists(solarelev_arg)) {
					var illumination = parseInt(q.value(illumination_arg));
					var elevation = parseFloat(q.value(elevation_arg));
					var azimuth = parseFloat(q.value(azimuth_arg));
					var solarelev = parseFloat(q.value(solarelev_arg));
					
					// consider that solarelev may need to be < -6 or so to be dark
					if (illumination == 0 && elevation > 0 && solarelev < 0) {
						caption += '<p>' + satellite_name + ' was <em>potentially</em> visible from your location at this time ';
						caption +=  '(elevation: ' + elevation + '&deg;, azimuth ' + azimuth + '&deg).</p>';
					} else {
						caption += '<p>' + satellite_name + ' was probably <em>not</em> visible from your location at this time. (';
						
						var reasons = [];
						if (illumination != 0)
							reasons.push('It was in the earth\'s shadow.');
						if (elevation <= 0)
							reasons.push('It was below the horizon.');
						if (solarelev >= 0)
							reasons.push('The sun was above the horizon.');
						
						caption += reasons.join(' ') + ')</p>';
					}
				}
				
				var infopanel = AddInfoToPanel(panel, caption, id);
				
				// highlight info panels when pointing at markers
				google.maps.event.addListener(marker, 'mouseover', function() {
					infopanel.style.borderColor = "blue";
					
				});
				google.maps.event.addListener(marker, 'mouseout', function() {
					infopanel.style.borderColor = "gray";
				});
				
				// highlight markers when pointing at info panels
				infopanel.addEventListener('mouseover', function() {
					var markerdiv = document.getElementById(id + '-marker');
					markerdiv.style.borderColor = "blue";
					infopanel.style.borderColor = "blue";
				});
				
				infopanel.addEventListener('mouseout', function() {
					var markerdiv = document.getElementById(id + '-marker');
					markerdiv.style.borderColor = "transparent";
					infopanel.style.borderColor = "gray";
				});
			}
						
			function initialize() {
				
				// Page layout divs
				var content = document.getElementById("content");
				var map_canvas = document.getElementById("map_canvas");
				var rightpanel = document.getElementById("rightpanel");
				var footer = document.getElementById("footer");
				
				// Create the basemap.
				var map = new google.maps.Map(map_canvas, {
						backgroundColor: "#AAAADD",
						center: new google.maps.LatLng(0, 0),
						zoom: 2,
						mapTypeId: google.maps.MapTypeId.ROADMAP,
						panControl: true,
						zoomControl: true,
						mapTypeControl: true,
						scaleControl: true,
						streetViewControl: false,
						overviewMapControl: true,
						overviewMapControlOptions: {
							opened: false
						}});
				
				q = new QueryString();
				
				var satelliteName;
				if (q.exists('sn')) {
					satelliteName = q.value('sn');
				} else {
					satelliteName = 'the satellite';
				}
				
				var userName;
				if (q.exists('un')) {
					userName = q.value('un');
				} else {
					userName = 'you';
				}
				
				var tweetID;
				if (q.exists('ut')) {
					tweetID = q.value('ut');
				} else {
					tweetID = 0;
				}
				
				
				// Create polyline to represent ground track.
				if (q.exists('ll') && q.exists('t1') && q.exists('t2')) {
	
					rightpanel.style.width = "250px";
					map_canvas.style.right = "250px";
										
					var traceStartTime = new Date(parseInt(q.value('t1')) * 1000);
					var traceEndTime   = new Date(parseInt(q.value('t2')) * 1000);
					
					// Assemble list of ground track coordinates from ll parameter strings.
					var traceParameters = q.values('ll');
					var traceCoordinates = [];
					var traceExtent = new google.maps.LatLngBounds();
					for (var i = 0; i < traceParameters.length; i++) {
						var ll = CoordinateParameterToLatLon(traceParameters[i]);
						var point = new google.maps.LatLng(ll[0], ll[1]);
						traceExtent.extend(point);
						traceCoordinates.push(point);
					}
					
					// Create the ground track and place it on the map
					var trace = new google.maps.Polyline({
							path: traceCoordinates,
							strokeOpacity: 0.6,
							strokeColor: "#008800",
							strokeWeight: 8,
							geodesic: true,
							clickable: false,
							map: map});
					
					var tweetlink = 'https://twitter.com/' + userName + '/statuses/' + tweetID;
					var searchlink = 'http://nssdc.gsfc.nasa.gov/nmc/spacecraftSearch.do?spacecraft=' + escape(satelliteName);
					var caption = '<p>The green line depicts the ground track of <a href="' + searchlink + '">' + satelliteName + '</a> from ' + FormatTimestamp(traceStartTime) + ' to ' + FormatTimestamp(traceEndTime) + '.</p>';
					
					AddInfoToPanel(rightpanel, caption, 'trace');
				
					// Create marker to represent Observer position.
					if (q.exists('ol')) {
						var ll = CoordinateParameterToLatLon(q.value('ol'));
						var point = new google.maps.LatLng(ll[0], ll[1]);
						traceExtent.extend(point);
						// <img src="https://api.twitter.com/1/users/profile_image?screen_name=' + userName + '&size=mini" style="left:12px; top:8px;position:absolute;">
						var observerMarker = new RichMarker({
								position: point,
								animation: google.maps.Animation.DROP,
								title: userName,
								content: '<div id="observer-marker"><img src="images/user-location.png"></div>',
								anchor: RichMarkerPosition.BOTTOM,
								draggable: false,
								flat: true,
								map: map});
						
						var obscaption = '<p><img src="images/user-location.png" /></p><p>Your location is ' + FormatLatLon(ll) + '.</p>';
						var obsinfo = AddInfoToPanel(rightpanel, obscaption, 'observer');
						
						
						google.maps.event.addListener(observerMarker, 'mouseover', function() {
							obsinfo.style.borderColor = "blue";
						});
						google.maps.event.addListener(observerMarker, 'mouseout', function() {
							obsinfo.style.borderColor = "gray";
						});
						
						obsinfo.addEventListener('mouseover', function() {
							var md = document.getElementById('observer-marker');
							md.style.borderColor = "blue";
							obsinfo.style.borderColor = "blue";
						});
						obsinfo.addEventListener('mouseout', function() {
							var md = document.getElementById('observer-marker');
							md.style.borderColor = "transparent";
							obsinfo.style.borderColor = "gray";
						});
					}

					// Adjust map extent to focus on ground track.
					map.fitBounds(traceExtent);
					
					// Create marker to represent Mention position.
					if (q.exists('ml') && q.exists('ma') && q.exists('mh') && q.exists('ms') && q.exists('mt')) {
						
						// Set page title to mention satellite name and primary time
						var timestamp = new Date(parseInt(q.value('mt')) * 1000);
						document.title = "Where's That Sat: " + satelliteName + ' on ' + FormatTimestamp(timestamp);
						
						MarkPlace(map, q, 'ma', 'mh', 'ms', 'mt', 'ml', 'mi', 'me', 'mz', 'mo',
								userName, satelliteName, 'images/green-droplet.png', rightpanel, 'mention',
								'When you <a href="' + tweetlink + '">mentioned</a> it');				
								
						// Create marker to represent Reply position, if specified.
						if (q.exists('rl') && q.exists('ra') && q.exists('rh') && q.exists('rs') && q.exists('rt')) {
							MarkPlace(map, q, 'ra', 'rh', 'rs', 'rt', 'rl', 'ri', 're', 'rz', 'ro',
									userName, satelliteName, 'images/orange-droplet.png', rightpanel, 'reply',
									'When @WheresThatSat replied');
						}
					
					}
					
					// Prompt user to ask about this satellite again
					{
						var askcaption = '<p><img src="images/tweet-reply.png" /> <a href="https://twitter.com/intent/tweet?text=' + escape('@WheresThatSat ' + satelliteName) + '">Where\'s this sat now?</a></p>';
						AddInfoToPanel(rightpanel, askcaption, 'ask');
					}
					
					// Display referrer link iff it's a t.co shortlink
					if ((document.referrer != '') && (document.referrer.split('/')[2] == 't.co')) {
						var refcaption = '<p>Link to this map page: <a href="' + document.referrer + '">' + document.referrer + '</a></p>';
						AddInfoToPanel(rightpanel, refcaption, 'referrer');
					}
				
				}
			}
		</script>
	</head>
	<body onload="initialize()">
		<div id="header" class="row">
		Where's That Sat?
		</div>
		<div id="content" class="row">
			<div id="map_canvas" class="col"></div>
			<div id="rightpanel" class="col scrolly"></div>
		</div>
		<div id="footer" class="row"> </div>
	</body>
</html>
